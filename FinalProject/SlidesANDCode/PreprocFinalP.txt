# Create a new environment for transcriptomics (if already made one skip to next line)
conda create -n transcriptomics

# activate that environment
conda activate transcriptomics

# install the necessary packages (skip it already installed)
conda install -c bioconda hisat2
conda install -c bioconda samtools
conda install -c bioconda stringtie
conda install -c bioconda gffcompare

# Download the transcriptome data set and reference genome files (as .fna, .fasta, and .gff) from the NCBI website. From NCBI, there are also 4 files, 2 for WT and 2 FurC. 
The .fna, .fasta, and .gff files should be directly in the folder.  
The reads will be in another file called fastq. 


#Unzipping any files in that folder
gunzip fastq/*.gz

# Prepare the genome file
hisat2-build ngon.fna ngon

# Align reads to genome and assemble the transcripts 

hisat2 -q -x ngon -U fastq/WT02.fastq -S WT02.sam
hisat2 -q -x ngon -U fastq/WT01.fastq -S WT01.sam
hisat2 -q -x ngon -U fastq/FurC02.fastq -S FurC02.sam
hisat2 -q -x ngon -U fastq/FurC01.fastq -S FurC01.sam


# Convert the .sam file to a .bam file. (Delete sam file after)

samtools view -bS WT02.sam > WT02.bam
samtools view -bS WT01.sam > WT01.bam
samtools view -bS FurC02.sam > FurC02.bam
samtools view -bS FurC01.sam > FurC01.bam


# Convert the .bam to a sorted .bam. This compresses the file and sorts the variants for easier discovery. 

samtools sort WT02.bam -o WT02.sorted.bam
samtools sort WT01.bam -o WT01.sorted.bam
samtools sort FurC02.bam -o FurC02.sorted.bam
samtools sort FurC01.bam -o FurC01.sorted.bam


# Reconstruct transcripts for each sample. 

stringtie WT02.sorted.bam -G genomic.gff -o stringtie/WT02.transcripts.gtf
stringtie WT01.sorted.bam -G genomic.gff -o stringtie/WT01.transcripts.gtf
stringtie FurC02.sorted.bam -G genomic.gff -o stringtie/FurC02.transcripts.gtf
stringtie FurC01.sorted.bam -G genomic.gff -o stringtie/FurC01.transcripts.gtf



# Create a file with the names of the files. (Remember, file 1 gets >. Files 2-4 >>)

echo stringtie/WT02.transcripts.gtf >> assemblies.txt
echo stringtie/WT01.transcripts.gtf > assemblies.txt
echo stringtie/FurC02.transcripts.gtf >> assemblies.txt
echo stringtie/FurC01.transcripts.gtf >> assemblies.txt


# Verify that assemblies.txt contains all file names 
cat assemblies.txt


# Merge the transcripts
stringtie --merge -G genomic.gff -o stringtie_merged.gtf assemblies.txt

# Count the number of lines in the merged file
cat stringtie_merged.gtf | grep -v "^#" | awk '$3=="transcript" {print}' | wc -l

2330


# Compare assembled transcripts to known transcripts
gffcompare -r genomic.gff -G -o merged stringtie_merged.gtf

  2283 reference transcripts loaded.
  2330 query transfrags loaded.


# View success of comparison
  cat merged.stats
-----------------------------------------------------------------------------------------------------
# gffcompare v0.12.6 | Command line was:
#gffcompare -r genomic.gff -G -o merged stringtie_merged.gtf
#

#= Summary for dataset: stringtie_merged.gtf 
#     Query mRNAs :    2330 in    2013 loci  (46 multi-exon transcripts)
#            (13 multi-transcript loci, ~1.2 transcripts per locus)
# Reference mRNAs :    2283 in    2058 loci  (0 multi-exon)
# Super-loci w/ reference transcripts:     2008
#-----------------| Sensitivity | Precision  |
        Base level:   100.0     |    99.4    |
        Exon level:    90.2     |    85.6    |
  Transcript level:    92.2     |    90.3    |
       Locus level:    99.2     |    99.0    |

     Matching intron chains:       0
       Matching transcripts:    2104
              Matching loci:    2041

          Missed exons:       0/2283	(  0.0%)
           Novel exons:      16/2407	(  0.7%)
         Novel introns:      83/83	(100.0%)
           Missed loci:       0/2058	(  0.0%)
            Novel loci:       5/2013	(  0.2%)

 Total union super-loci across all input datasets: 2013 
2330 out of 2330 consensus transcripts written in merged.annotated.gtf (0 discarded as redundant)

-----------------------------------------------------------------------------------------------------

# Estimate abundance and create Ballgown folder (for use in visualization).

stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/WT02/WT02.gtf WT02.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/WT01/WT01.gtf WT01.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/FurC02/FurC02.gtf FurC02.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/FurC01/FurC01.gtf FurC01.sorted.bam





